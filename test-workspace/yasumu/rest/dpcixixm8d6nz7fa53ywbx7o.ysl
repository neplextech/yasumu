@rest

metadata {
  name: "Echo server"
  method: "POST"
  id: "dpcixixm8d6nz7fa53ywbx7o"
  groupId: "mv2z3sr80ai1cv2axxap3juq"
}

request {
  url: "{{API_URL}}/:path"
  headers: [
    {
      key: "X-Custom-Header"
      value: "1234HELLO"
      enabled: true
    },
    {
      key: "Authorization"
      value: "Bearer BearerToken123432245325"
      enabled: true
    },
  ]
  parameters: [
    {
      key: "path"
      value: "users"
      enabled: true
    },
  ]
  searchParameters: [
    {
      key: "userId"
      value: "{{USER_ID}}"
      enabled: true
    },
  ]
  body: {
    type: "json"
    content: "[\n  {\n    \"url\": \"http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=http://localhost:53469/:path?userId=\",\n    \"path\": \"/:path\",\n    \"method\": \"GET\",\n    \"headers\": {\n      \"accept\": \"*/*\",\n      \"authorization\": \"Bearer BearerToken123432245325\",\n      \"host\": \"localhost:53469\",\n      \"origin\": \"http://localhost\",\n      \"user-agent\": \"Yasumu/1.0\",\n      \"x-current-user-id\": \"\",\n      \"x-custom-header\": \"1234HELLO\",\n      \"x-request-id\": \"g148q7iiw3rcys07ar5rn797\"\n    },\n    \"args\": {\n      \"userId\": \"\"\n    },\n    \"cookies\": {},\n    \"body\": \"\",\n    \"json\": null,\n    \"form\": null,\n    \"files\": {},\n    \"data\": \"\",\n    \"meta\": {\n      \"timestamp\": \"2026-01-02T12:38:52.402Z\",\n      \"source\": \"tanxium-echo-server\"\n    }\n  },\n  {\n    \"url\": \"http://localhost:53469/:path?userId=\",\n    \"path\": \"/:path\",\n    \"method\": \"GET\",\n    \"headers\": {\n      \"accept\": \"*/*\",\n      \"authorization\": \"Bearer BearerToken123432245325\",\n      \"host\": \"localhost:53469\",\n      \"origin\": \"http://localhost\",\n      \"user-agent\": \"Yasumu/1.0\",\n      \"x-current-user-id\": \"\",\n      \"x-custom-header\": \"1234HELLO\",\n      \"x-request-id\": \"g148q7iiw3rcys07ar5rn797\"\n    },\n    \"args\": {\n      \"userId\": \"\"\n    },\n    \"cookies\": {},\n    \"body\": \"\",\n    \"json\": null,\n    \"form\": null,\n    \"files\": {},\n    \"data\": \"\",\n    \"meta\": {\n      \"timestamp\": \"2026-01-02T12:38:52.402Z\",\n      \"source\": \"tanxium-echo-server\"\n    }\n  },\n  {\n    \"url\": \"http://localhost:53469/:path?userId=\",\n    \"path\": \"/:path\",\n    \"method\": \"GET\",\n    \"headers\": {\n      \"accept\": \"*/*\",\n      \"authorization\": \"Bearer BearerToken123432245325\",\n      \"host\": \"localhost:53469\",\n      \"origin\": \"http://localhost\",\n      \"user-agent\": \"Yasumu/1.0\",\n      \"x-current-user-id\": \"\",\n      \"x-custom-header\": \"1234HELLO\",\n      \"x-request-id\": \"g148q7iiw3rcys07ar5rn797\"\n    },\n    \"args\": {\n      \"userId\": \"\"\n    },\n    \"cookies\": {},\n    \"body\": \"\",\n    \"json\": null,\n    \"form\": null,\n    \"files\": {},\n    \"data\": \"\",\n    \"meta\": {\n      \"timestamp\": \"2026-01-02T12:38:52.402Z\",\n      \"source\": \"tanxium-echo-server\"\n    }\n  },\n  {\n    \"url\": \"http://localhost:53469/:path?userId=\",\n    \"path\": \"/:path\",\n    \"method\": \"GET\",\n    \"headers\": {\n      \"accept\": \"*/*\",\n      \"authorization\": \"Bearer BearerToken123432245325\",\n      \"host\": \"localhost:53469\",\n      \"origin\": \"http://localhost\",\n      \"user-agent\": \"Yasumu/1.0\",\n      \"x-current-user-id\": \"\",\n      \"x-custom-header\": \"1234HELLO\",\n      \"x-request-id\": \"g148q7iiw3rcys07ar5rn797\"\n    },\n    \"args\": {\n      \"userId\": \"\"\n    },\n    \"cookies\": {},\n    \"body\": \"\",\n    \"json\": null,\n    \"form\": null,\n    \"files\": {},\n    \"data\": \"\",\n    \"meta\": {\n      \"timestamp\": \"2026-01-02T12:38:52.402Z\",\n      \"source\": \"tanxium-echo-server\"\n    }\n  },\n  {\n    \"url\": \"http://localhost:53469/:path?userId=\",\n    \"path\": \"/:path\",\n    \"method\": \"GET\",\n    \"headers\": {\n      \"accept\": \"*/*\",\n      \"authorization\": \"Bearer BearerToken123432245325\",\n      \"host\": \"localhost:53469\",\n      \"origin\": \"http://localhost\",\n      \"user-agent\": \"Yasumu/1.0\",\n      \"x-current-user-id\": \"\",\n      \"x-custom-header\": \"1234HELLO\",\n      \"x-request-id\": \"g148q7iiw3rcys07ar5rn797\"\n    },\n    \"args\": {\n      \"userId\": \"\"\n    },\n    \"cookies\": {},\n    \"body\": \"\",\n    \"json\": null,\n    \"form\": null,\n    \"files\": {},\n    \"data\": \"\",\n    \"meta\": {\n      \"timestamp\": \"2026-01-02T12:38:52.402Z\",\n      \"source\": \"tanxium-echo-server\"\n    }\n  },\n  {\n    \"url\": \"http://localhost:53469/:path?userId=\",\n    \"path\": \"/:path\",\n    \"method\": \"GET\",\n    \"headers\": {\n      \"accept\": \"*/*\",\n      \"authorization\": \"Bearer BearerToken123432245325\",\n      \"host\": \"localhost:53469\",\n      \"origin\": \"http://localhost\",\n      \"user-agent\": \"Yasumu/1.0\",\n      \"x-current-user-id\": \"\",\n      \"x-custom-header\": \"1234HELLO\",\n      \"x-request-id\": \"g148q7iiw3rcys07ar5rn797\"\n    },\n    \"args\": {\n      \"userId\": \"\"\n    },\n    \"cookies\": {},\n    \"body\": \"\",\n    \"json\": null,\n    \"form\": null,\n    \"files\": {},\n    \"data\": \"\",\n    \"meta\": {\n      \"timestamp\": \"2026-01-02T12:38:52.402Z\",\n      \"source\": \"tanxium-echo-server\"\n    }\n  },\n  {\n    \"url\": \"http://localhost:53469/:path?userId=\",\n    \"path\": \"/:path\",\n    \"method\": \"GET\",\n    \"headers\": {\n      \"accept\": \"*/*\",\n      \"authorization\": \"Bearer BearerToken123432245325\",\n      \"host\": \"localhost:53469\",\n      \"origin\": \"http://localhost\",\n      \"user-agent\": \"Yasumu/1.0\",\n      \"x-current-user-id\": \"\",\n      \"x-custom-header\": \"1234HELLO\",\n      \"x-request-id\": \"g148q7iiw3rcys07ar5rn797\"\n    },\n    \"args\": {\n      \"userId\": \"\"\n    },\n    \"cookies\": {},\n    \"body\": \"\",\n    \"json\": null,\n    \"form\": null,\n    \"files\": {},\n    \"data\": \"\",\n    \"meta\": {\n      \"timestamp\": \"2026-01-02T12:38:52.402Z\",\n      \"source\": \"tanxium-echo-server\"\n    }\n  },\n  {\n    \"url\": \"http://localhost:53469/:path?userId=\",\n    \"path\": \"/:path\",\n    \"method\": \"GET\",\n    \"headers\": {\n      \"accept\": \"*/*\",\n      \"authorization\": \"Bearer BearerToken123432245325\",\n      \"host\": \"localhost:53469\",\n      \"origin\": \"http://localhost\",\n      \"user-agent\": \"Yasumu/1.0\",\n      \"x-current-user-id\": \"\",\n      \"x-custom-header\": \"1234HELLO\",\n      \"x-request-id\": \"g148q7iiw3rcys07ar5rn797\"\n    },\n    \"args\": {\n      \"userId\": \"\"\n    },\n    \"cookies\": {},\n    \"body\": \"\",\n    \"json\": null,\n    \"form\": null,\n    \"files\": {},\n    \"data\": \"\",\n    \"meta\": {\n      \"timestamp\": \"2026-01-02T12:38:52.402Z\",\n      \"source\": \"tanxium-echo-server\"\n    }\n  },\n  {\n    \"url\": \"http://localhost:53469/:path?userId=\",\n    \"path\": \"/:path\",\n    \"method\": \"GET\",\n    \"headers\": {\n      \"accept\": \"*/*\",\n      \"authorization\": \"Bearer BearerToken123432245325\",\n      \"host\": \"localhost:53469\",\n      \"origin\": \"http://localhost\",\n      \"user-agent\": \"Yasumu/1.0\",\n      \"x-current-user-id\": \"\",\n      \"x-custom-header\": \"1234HELLO\",\n      \"x-request-id\": \"g148q7iiw3rcys07ar5rn797\"\n    },\n    \"args\": {\n      \"userId\": \"\"\n    },\n    \"cookies\": {},\n    \"body\": \"\",\n    \"json\": null,\n    \"form\": null,\n    \"files\": {},\n    \"data\": \"\",\n    \"meta\": {\n      \"timestamp\": \"2026-01-02T12:38:52.402Z\",\n      \"source\": \"tanxium-echo-server\"\n    }\n  },\n  {\n    \"url\": \"http://localhost:53469/:path?userId=\",\n    \"path\": \"/:path\",\n    \"method\": \"GET\",\n    \"headers\": {\n      \"accept\": \"*/*\",\n      \"authorization\": \"Bearer BearerToken123432245325\",\n      \"host\": \"localhost:53469\",\n      \"origin\": \"http://localhost\",\n      \"user-agent\": \"Yasumu/1.0\",\n      \"x-current-user-id\": \"\",\n      \"x-custom-header\": \"1234HELLO\",\n      \"x-request-id\": \"g148q7iiw3rcys07ar5rn797\"\n    },\n    \"args\": {\n      \"userId\": \"\"\n    },\n    \"cookies\": {},\n    \"body\": \"\",\n    \"json\": null,\n    \"form\": null,\n    \"files\": {},\n    \"data\": \"\",\n    \"meta\": {\n      \"timestamp\": \"2026-01-02T12:38:52.402Z\",\n      \"source\": \"tanxium-echo-server\"\n    }\n  }\n]"
  }
}

dependencies []

script {
  let reqId: string, runs: number = 0;
  
  export async function onRequest(req: YasumuRequest) {
    runs++;
    reqId = Yasumu.cuid()
    const userId = req.env.getSecret('USER_ID')
    req.headers.set('x-current-user-id', userId || 'NONE')
    req.headers.set('x-request-id', reqId)
  }
  
  export async function onResponse(req: YasumuRequest, res: YasumuResponse) {
    res.env.setVariable('SOURCE', res.json<any>().meta.source)
    res.env.setVariable('TIMESTAMP', res.json<any>().meta.timestamp)
  
    await Yasumu.ui.showNotification({
      title: `Info for request ${reqId}`,
      message: `Your request has been processed!`,
      variant: 'info',
    });
  }
  
  export async function onTest(req: YasumuRequest, res: YasumuResponse) {
    test('Response is successful', () => {
      expect(res.status).toBe(200)
    })
    test(`Pass | Run: ${runs}`, (ctx) => {
      ctx.succeed()
    })
    test('Fail', (ctx) => {
      ctx.fail()
    })
    test(`Skip ${reqId}`, (ctx) => {
      ctx.skip()
    })
  }
}

